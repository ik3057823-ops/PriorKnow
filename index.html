import React, { useEffect, useMemo, useState } from "react";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Progress } from "@/components/ui/progress";
import { Info } from "lucide-react";

const WORDS = [
  "diet",
  "junk food",
  "whole food",
  "food security",
  "takeaway",
];

const LEVELS = [
  { value: 1, short: "Brand‑new", desc: "I haven't met this word before." },
  { value: 2, short: "Looks familiar", desc: "I've seen it, but I'm not sure." },
  { value: 3, short: "I get it when I read", desc: "I can explain the meaning." },
  { value: 4, short: "Sentence‑ready", desc: "I can use it in a simple sentence." },
  { value: 5, short: "Confident & flexible", desc: "I can use it with collocations/register." },
];

const ACTIONS: Record<number, { title: string; items: string[] }> = {
  1: {
    title: "Before you learn: make it visible",
    items: [
      "Check a simple definition + picture (L1 allowed).",
      "Say it aloud and mark the stressed syllable.",
      "Write a 5‑word hint (e.g., 'food plan over time').",
    ],
  },
  2: {
    title: "Firm up meaning & form",
    items: [
      "Do a quick 'true/false' definition check.",
      "Create one personal example (short, simple).",
      "Add one synonym or contrast word (e.g., 'fresh vs processed').",
    ],
  },
  3: {
    title: "Bridge to using it",
    items: [
      "Complete one sentence frame (e.g., 'a ___ meal').",
      "Choose one safe collocation and use it once (e.g., 'nutritious meal').",
      "Note the grammar pattern if needed (e.g., 'be tempted to + V').",
    ],
  },
  4: {
    title: "Stretch your use",
    items: [
      "Write 2 different sentences (change tense/register).",
      "Add 2 collocations or a typical context (e.g., 'highly processed').",
      "Swap word family once (e.g., 'digest' → 'digestion').",
    ],
  },
  5: {
    title: "Keep it active",
    items: [
      "Teach it in 10 seconds to a peer (or record yourself).",
      "Write one tricky distractor sentence to challenge others.",
      "Schedule spaced review (1, 3, 7 days).",
    ],
  },
};

export default function App() {
  const [step, setStep] = useState<"rate" | "summary" | "video">("rate");
  const [ratings, setRatings] = useState<Record<string, number>>(() => {
    const saved = localStorage.getItem("food-vocab-minimal");
    if (saved) return JSON.parse(saved);
    const init: Record<string, number> = {};
    WORDS.forEach((w) => (init[w] = 0));
    return init;
  });

  useEffect(() => {
    localStorage.setItem("food-vocab-minimal", JSON.stringify(ratings));
  }, [ratings]);

  const doneCount = useMemo(() => Object.values(ratings).filter((v) => v > 0).length, [ratings]);

  function setLevel(word: string, level: number) {
    setRatings((r) => ({ ...r, [word]: level }));
  }

  if (step === "summary") return <Summary ratings={ratings} onBack={() => setStep("rate")} onNext={() => setStep("video")} />;
  if (step === "video") return <VideoScreen ratings={ratings} onBack={() => setStep("summary")} />;

  return (
    <div className="min-h-screen bg-white text-slate-900 p-4 md:p-8">
      <div className="max-w-3xl mx-auto space-y-6">
        <header className="space-y-2">
          <h1 className="text-3xl font-semibold tracking-tight">Food Vocabulary — Quick Self‑Check</h1>
          <p className="text-slate-600">Choose <span className="font-medium">one number (1–5)</span> for each word. Keep it fast and simple.</p>
        </header>

        <Card className="border-slate-200">
          <CardContent className="p-4 space-y-3">
            <div className="flex items-center gap-2 text-slate-700"><Info className="h-5 w-5"/><span className="font-medium">What the numbers mean</span></div>
            <ol className="text-sm grid gap-1 list-decimal ml-5">
              {LEVELS.map((L) => (
                <li key={L.value}><span className="font-medium">{L.value}. {L.short}</span> — {L.desc}</li>
              ))}
            </ol>
          </CardContent>
        </Card>

        <div className="space-y-2">
          <div className="flex items-center justify-between text-sm text-slate-700">
            <span>Rated: {doneCount}/{WORDS.length}</span>
            <span>{Math.round((doneCount / WORDS.length) * 100)}%</span>
          </div>
          <Progress value={(doneCount / WORDS.length) * 100} />
        </div>

        <div className="grid gap-3">
          {WORDS.map((word) => (
            <Card key={word} className="border-slate-200">
              <CardContent className="p-4 space-y-2">
                <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                  <div>
                    <div className="text-lg font-medium leading-tight">{word}</div>
                    <div className="text-xs text-slate-500">Pick 1–5</div>
                  </div>
                  <div className="inline-flex rounded-xl overflow-hidden border">
                    {LEVELS.map((L, idx) => (
                      <Button
                        key={L.value}
                        size="sm"
                        variant={ratings[word] === L.value ? "default" : "ghost"}
                        className={`rounded-none px-3 ${idx !== LEVELS.length - 1 ? "border-r" : ""}`}
                        onClick={() => setLevel(word, L.value)}
                        aria-label={`${word}: ${L.value} ${L.short}`}
                      >
                        {L.value}
                      </Button>
                    ))}
                  </div>
                </div>
                {ratings[word] > 0 && (
                  <div className="text-xs text-slate-600 border rounded-lg p-2 bg-slate-50">
                    <span className="font-medium">{LEVELS.find((l) => l.value === ratings[word])?.short}:</span>{" "}
                    {LEVELS.find((l) => l.value === ratings[word])?.desc}
                  </div>
                )}
              </CardContent>
            </Card>
          ))}
        </div>

        <div className="flex items-center justify-between text-sm">
          <div className="text-slate-500">That’s it. Fast snapshot before learning.</div>
          <div className="flex gap-2">
            <Button variant="outline" onClick={() => {
              if (!confirm("Clear all ratings?")) return;
              const cleared: Record<string, number> = {}; WORDS.forEach((w) => (cleared[w] = 0)); setRatings(cleared);
            }}>Clear</Button>
            <Button onClick={() => {
              const allRated = WORDS.every((w) => ratings[w] > 0);
              if (!allRated && !confirm("Some words are unrated. Continue to summary?")) return;
              setStep("summary");
            }}>Next</Button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Summary({ ratings, onBack, onNext }: { ratings: Record<string, number>; onBack: () => void; onNext: () => void }) {
  const groups = useMemo(() => {
    const g: Record<number, string[]> = { 1: [], 2: [], 3: [], 4: [], 5: [] };
    Object.entries(ratings).forEach(([w, v]) => {
      if (v > 0) g[v as 1 | 2 | 3 | 4 | 5].push(w);
    });
    return g;
  }, [ratings]);

  const totalRated = Object.values(ratings).filter((v) => v > 0).length;

  return (
    <div className="min-h-screen bg-white text-slate-900 p-4 md:p-8">
      <div className="max-w-4xl mx-auto space-y-6">
        <header className="space-y-1">
          <h2 className="text-2xl font-semibold tracking-tight">Summary & Next Steps</h2>
          <p className="text-slate-600">Pre‑learning plan based on your self‑check ({totalRated}/{WORDS.length} rated).</p>
        </header>

        <div className="grid gap-4 md:grid-cols-2">
          {LEVELS.map((L) => (
            <Card key={L.value} className="border-slate-200">
              <CardContent className="p-4 space-y-3">
                <div className="flex items-center justify-between">
                  <div className="font-medium">{L.value}. {L.short}</div>
                  <Badge variant={groups[L.value].length ? "default" : "secondary"}>{groups[L.value].length} word(s)</Badge>
                </div>
                <ul className="text-sm list-disc ml-5 text-slate-700">
                  {ACTIONS[L.value].items.map((it, idx) => (
                    <li key={idx}>{it}</li>
                  ))}
                </ul>
                {groups[L.value].length > 0 && (
                  <div className="text-xs text-slate-600">
                    <span className="font-medium">Your words:</span> {groups[L.value].join(", ")}
                  </div>
                )}
              </CardContent>
            </Card>
          ))}
        </div>

        <div className="flex items-center justify-between">
          <Button variant="outline" onClick={onBack}>Back</Button>
          <Button onClick={onNext}>Next</Button>
        </div>
      </div>
    </div>
  );
}

function VideoScreen({ ratings, onBack }: { ratings: Record<string, number>; onBack: () => void }) {
  const VIDEO_URL = "https://youtu.be/LRKlGG0oYKw";
  function getYouTubeId(u: string) {
    try {
      const url = new URL(u);
      if (url.hostname.includes("youtu.be")) return url.pathname.replace("/", "");
      if (url.hostname.includes("youtube.com")) return url.searchParams.get("v") || "";
      return "";
    } catch {
      return "";
    }
  }
  const VIDEO_ID = getYouTubeId(VIDEO_URL);
  const starts: Record<string, number> = {
    "diet": 46,
    "junk food": 132,
    "whole food": 225,
    "food security": 287,
    "takeaway": 359,
  };
  const ordered = ["diet", "junk food", "whole food", "food security", "takeaway"];
  const segs = ordered.map((w, i) => ({
    word: w,
    start: starts[w],
    end: i < ordered.length - 1 ? starts[ordered[i + 1]] - 1 : undefined,
    level: ratings[w] || 0,
  }));
  const needed = segs.filter((s) => s.level >= 1 && s.level <= 3);
  const [fullMode, setFullMode] = useState(false);
  const [idx, setIdx] = useState(0);
  const [completed, setCompleted] = useState<boolean[]>(() => needed.map(() => false));
  const total = needed.length;
  const progress = total ? Math.round((completed.filter(Boolean).length / total) * 100) : 0;
  function buildUrl(start?: number, end?: number) {
    const params = new URLSearchParams({ rel: "0", modestbranding: "1", controls: "1" });
    if (start !== undefined) params.set("start", String(start));
    if (end !== undefined) params.set("end", String(end));
    params.set("autoplay", "1");
    return `https://www.youtube.com/embed/${VIDEO_ID}?${params.toString()}`;
  }
  const current = needed[idx];
  return (
    <div className="min-h-screen bg-white text-slate-900 p-4 md:p-8">
      <div className="max-w-4xl mx-auto space-y-6">
        <header className="space-y-1">
          <h2 className="text-2xl font-semibold tracking-tight">Targeted Video Practice</h2>
          <p className="text-slate-600">We’ll skip words you already use well (4–5). You can switch to the full video any time.</p>
        </header>
        <div className="space-y-2">
          <div className="flex items-center justify-between text-sm text-slate-700">
            <span>Segments completed: {completed.filter(Boolean).length}/{total}</span>
            <span>{progress}%</span>
          </div>
          <Progress value={progress} />
        </div>
        <div className="flex flex-wrap items-center justify-between gap-2">
          <div className="text-sm text-slate-700">
            Mode: {fullMode ? <span className="font-medium">Full video (no skips)</span> : <span className="font-medium">Focused segments (1–3)</span>}
          </div>
          <div className="flex gap-2">
            <Button variant={fullMode ? "default" : "outline"} onClick={() => setFullMode(true)}>Watch full video</Button>
            <Button variant={!fullMode ? "default" : "outline"} onClick={() => setFullMode(false)} disabled={total === 0}>Watch focused parts</Button>
          </div>
        </div>
        <Card className="border-slate-200">
          <CardContent className="p-3 md:p-4 space-y-3">
            {!fullMode && total === 0 && (
              <div className="text-slate-600 text-sm">Nice! You rated everything 4–5. Switch to <span className="font-medium">Full video</span> to watch without skips.</div>
            )}
            {fullMode ? (
              <div className="aspect-video w-full overflow-hidden rounded-xl">
                <iframe
                  className="w-full h-full"
                  src={buildUrl()}
                  title="YouTube video player"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                  allowFullScreen
                />
              </div>
            ) : total > 0 ? (
              <div className="space-y-3">
                <div className="text-sm text-slate-700"><span className="font-medium">Segment {idx + 1} of {total}</span> — {current.word}</div>
                <div className="aspect-video w-full overflow-hidden rounded-xl">
                  <iframe
                    className="w-full h-full"
                    src={buildUrl(current.start, current.end)}
                    title={`YouTube segment: ${current.word}`}
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                    allowFullScreen
                  />
                </div>
                <div className="flex flex-wrap items-center justify-between gap-2">
                  <div className="text-xs text-slate-600">Starts at {fmtTime(current.start)}{current.end ? ` · ends at ${fmtTime(current.end)}` : ""}</div>
                  <div className="flex gap-2">
                    <Button variant="outline" onClick={() => setIdx((i) => Math.max(0, i - 1))} disabled={idx === 0}>Prev</Button>
                    <Button variant="outline" onClick={() => setCompleted((c) => { const n=[...c]; n[idx]=true; return n; })}>Mark complete</Button>
                    <Button onClick={() => setIdx((i) => Math.min(total - 1, i + 1))} disabled={idx === total - 1}>Next</Button>
                  </div>
                </div>
                <div className="flex gap-1 flex-wrap">
                  {needed.map((s, i) => (
                    <button
                      key={i}
                      className={`h-2 w-6 rounded-full ${i === idx ? "bg-slate-900" : completed[i] ? "bg-slate-500" : "bg-slate-300"}`}
                      onClick={() => setIdx(i)}
                      aria-label={`Go to segment ${i + 1}: ${s.word}`}
                    />
                  ))}
                </div>
              </div>
            ) : null}
          </CardContent>
        </Card>
        <div className="flex items-center justify-between">
          <Button variant="outline" onClick={onBack}>Back</Button>
          <div className="text-sm text-slate-500">Tip: Use focused parts first, then watch the full video.</div>
        </div>
      </div>
    </div>
  );
}

function fmtTime(totalSeconds: number) {
  const m = Math.floor(totalSeconds / 60);
  const s = totalSeconds % 60;
  return `${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
}
